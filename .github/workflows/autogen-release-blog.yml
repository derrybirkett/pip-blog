name: Autogen Release Blog Post

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  draft:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Generate post from changelog
        id: gen
        run: |
          before="${{ github.event.before }}"
          if [ -z "$before" ] || [ "$before" = "0000000000000000000000000000000000000000" ]; then
            before="$(git rev-parse HEAD~1)"
          fi

          python3 ./.pip/bin/generate-release-blog-post.py \
            --before "$before" \
            --after "${{ github.sha }}"

      - name: Create PR
        if: steps.gen.outputs.created == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "docs(blog): autogen release post"
          branch: "autogen/blog-${{ steps.gen.outputs.release_date }}"
          delete-branch: true
          title: "docs(blog): release post for ${{ steps.gen.outputs.release_date }}"
          body: |
            Autogenerated blog post: `${{ steps.gen.outputs.post_path }}`

            - Source: `docs/changelog.md`
            - Escape hatch: apply label `hold` to prevent scheduled automerge.
          labels: |
            autogen-blog
            automerge
