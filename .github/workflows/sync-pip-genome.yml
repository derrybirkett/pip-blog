name: Sync .pip genome + autogen blog

on:
  schedule:
    - cron: "0 * * * *" # hourly
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Ensure .pip is up to date (fetch)
        run: |
          set -euo pipefail
          git -C .pip fetch origin main

      - name: Detect significant genome update
        id: sig
        run: |
          set -euo pipefail
          old="$(git -C .pip rev-parse HEAD)"
          new="$(git -C .pip rev-parse origin/main)"

          echo "old=$old" >> "$GITHUB_OUTPUT"
          echo "new=$new" >> "$GITHUB_OUTPUT"

          if [ "$old" = "$new" ]; then
            echo "significant=false" >> "$GITHUB_OUTPUT"
            echo "reason=no_genome_change" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Significant = a newly-added dated release heading in the genome changelog.
          if git -C .pip diff "$old..$new" -- docs/changelog.md | grep -E '^\+##\s+[0-9]{4}-[0-9]{2}-[0-9]{2}\s+—\s+' | grep -v 'Unreleased' >/dev/null; then
            echo "significant=true" >> "$GITHUB_OUTPUT"
            echo "reason=new_release_heading" >> "$GITHUB_OUTPUT"
          else
            echo "significant=false" >> "$GITHUB_OUTPUT"
            echo "reason=no_release_heading" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if no significant update
        if: steps.sig.outputs.significant != 'true'
        run: |
          echo "No significant genome update (${{ steps.sig.outputs.reason }}); skipping."

      - name: Bump submodule and sync changelog
        if: steps.sig.outputs.significant == 'true'
        run: |
          set -euo pipefail
          ts="$(date -u +%Y%m%d-%H%M%S)"
          branch="autogen/pip-sync-$ts"
          echo "BRANCH=$branch" >> "$GITHUB_ENV"

          git -C .pip checkout "${{ steps.sig.outputs.new }}"

          mkdir -p docs
          cp .pip/docs/changelog.md docs/changelog.md

      - name: Generate blog post from changelog
        if: steps.sig.outputs.significant == 'true'
        id: gen
        run: |
          set -euo pipefail
          before="${{ steps.sig.outputs.old }}"
          after="${{ steps.sig.outputs.new }}"

          # Set the after commit for changelog parsing (using new submodule commit)
          cd .pip
          python3 ./bin/generate-release-blog-post.py --before "$before" --after "$after" || echo "created=false" >> "$GITHUB_OUTPUT"
          cd ..
          
          # Move generated post if it exists
          if [ -f ".pip/_posts/"*".md" ]; then
            post_path=$(ls -t .pip/_posts/*.md | head -n1)
            cp "$post_path" "_posts/$(basename "$post_path")"
            mkdir -p blog
            cp "$post_path" "blog/$(basename "$post_path")"
            echo "created=true" >> "$GITHUB_OUTPUT"
            echo "post_path=_posts/$(basename "$post_path")" >> "$GITHUB_OUTPUT"
            # Extract date from filename for PR title
            filename=$(basename "$post_path")
            release_date=$(echo "$filename" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' | head -n1)
            echo "release_date=$release_date" >> "$GITHUB_OUTPUT"
          else
            echo "created=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Open PR
        if: steps.sig.outputs.significant == 'true' && steps.gen.outputs.created == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          add-paths: |
            .pip
            docs/changelog.md
            _posts/*.md
            blog/*.md
          commit-message: "docs(blog): autogen genome update"
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
          base: "${{ github.event.repository.default_branch }}"
          branch: "${{ env.BRANCH }}"
          delete-branch: true
          title: "docs(blog): genome update for ${{ steps.gen.outputs.release_date }}"
          body: |
            Autogenerated from `.pip/docs/changelog.md`.

            - .pip: `${{ steps.sig.outputs.old }} → ${{ steps.sig.outputs.new }}`
            - Post: `${{ steps.gen.outputs.post_path }}`
          labels: |
            autogen-blog
            automerge
