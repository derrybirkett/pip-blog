name: Sync .pip genome + autogen blog

on:
  schedule:
    - cron: "0 * * * *" # hourly
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Ensure .pip is up to date (fetch)
        run: |
          set -euo pipefail
          git -C .pip fetch origin main

      - name: Detect significant genome update
        id: sig
        run: |
          set -euo pipefail
          old="$(git -C .pip rev-parse HEAD)"
          new="$(git -C .pip rev-parse origin/main)"

          echo "old=$old" >> "$GITHUB_OUTPUT"
          echo "new=$new" >> "$GITHUB_OUTPUT"

          if [ "$old" = "$new" ]; then
            echo "significant=false" >> "$GITHUB_OUTPUT"
            echo "reason=no_genome_change" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Significant = a newly-added dated release heading in the genome changelog.
          if git -C .pip diff "$old..$new" -- docs/changelog.md | grep -E '^\+##\s+[0-9]{4}-[0-9]{2}-[0-9]{2}\s+—\s+' | grep -v 'Unreleased' >/dev/null; then
            echo "significant=true" >> "$GITHUB_OUTPUT"
            echo "reason=new_release_heading" >> "$GITHUB_OUTPUT"
          else
            echo "significant=false" >> "$GITHUB_OUTPUT"
            echo "reason=no_release_heading" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if no significant update
        if: steps.sig.outputs.significant != 'true'
        run: |
          echo "No significant genome update (${{ steps.sig.outputs.reason }}); skipping."

      - name: Create branch and bump submodule
        if: steps.sig.outputs.significant == 'true'
        run: |
          set -euo pipefail
          ts="$(date -u +%Y%m%d-%H%M%S)"
          branch="autogen/pip-sync-$ts"
          echo "BRANCH=$branch" >> "$GITHUB_ENV"

          git checkout -b "$branch"

          git -C .pip checkout "${{ steps.sig.outputs.new }}"
          git add .pip

          mkdir -p docs
          cp .pip/docs/changelog.md docs/changelog.md
          git add docs/changelog.md

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(genome): bump .pip + sync changelog"

      - name: Generate blog post from changelog
        if: steps.sig.outputs.significant == 'true'
        id: gen
        run: |
          set -euo pipefail
          before="$(git rev-parse origin/main)"
          after="$(git rev-parse HEAD)"

          python3 ./.pip/bin/generate-release-blog-post.py --before "$before" --after "$after"

      - name: Commit generated post
        if: steps.sig.outputs.significant == 'true' && steps.gen.outputs.created == 'true'
        run: |
          set -euo pipefail
          post_path="${{ steps.gen.outputs.post_path }}"
          mkdir -p blog
          cp "$post_path" "blog/$(basename "$post_path")"

          git add "$post_path" "blog/$(basename "$post_path")"
          git commit -m "docs(blog): autogen release post"

      - name: Open PR
        if: steps.sig.outputs.significant == 'true' && steps.gen.outputs.created == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "docs(blog): autogen genome update"
          branch: "${{ env.BRANCH }}"
          delete-branch: true
          title: "docs(blog): genome update for ${{ steps.gen.outputs.release_date }}"
          body: |
            Autogenerated from `.pip/docs/changelog.md`.

            - .pip: `${{ steps.sig.outputs.old }} → ${{ steps.sig.outputs.new }}`
            - Post: `${{ steps.gen.outputs.post_path }}`
          labels: |
            autogen-blog
            automerge
